# ch07-유닉스 도메인 소켓
- 모든 네트워크 프로그래밍이 노드 간에서만 발생하는 것은 아니다. 때때로 애플리케이션은 동일한 노드에 존재하는 데이터베이스 등의 서비스와 통신해야 할 필요가 있다.
- 애플리케이션에서 동일한 시스템 내 동작하는 데이터베이스에 접속하는 한 가지 방법으로 노드 자체의 IP 주소, 혹은 일반적으로 127.0.0.1로 사용되는 localhost  주소와 데이터베이스의 포트 번호를 사용하는 방법이 있다. 또 다른 방법으로는 유닉스 도메인 소켓을 사용하는 방법이 있다. 유닉스 도메인 소켓은 파일 시스템을 이용하여 패킷의 목적지 주소를 결정하는 통신 방법으로, 동일한 노드 내에 동작하는 서비스 간에 IPC(인터 프로세스 커뮤니케이션)라는 절차를 통해 데이터를 주고받을 수 있도록 해준다.

- 유닉스 도메인 소켓에 읽기와 쓰기를 제어하는 방법
- Go 언어에서 net 패키지를 사용하여 세 종류의 유닉스 도메인 소켓을 알아보고 각 종류의 소켓을 이용하여 간단한 에코 서버를 만든다.
- 유닉스 도메인 소켓을 이용하여 사용자와 그룹 아이디 정보로 클라이언트를 인증하는 서비스를 작성한다.


### 유닉스 도메인 소켓이란
- 네트워크 소켓이란 IP 주소와 포트 번호로 정의한다. 동일한 IP를 가진 동일한 노드 내에서 여러 어플리케이션에 대한 접근을 서로 다른 포트를 통해서 가능하게 해준다. IP 주소만 있고 포트 번호가 없다면 대기업에 한대의 전화기만 존재하는 것과 같은 상황일 것이다. 
- 유닉스 도메인 소켓은 소켓 주소 정의 원칙을 파일 시스템에 적용한다. 각 유닉스 도메인 소켓에는 파일 시스템 내에 연관된 파일이 존재하며, 그 파일은 네트워크 소켓의 IP 주소와 포트 번호에 대응한다. 해당 파일에 네트워크 연결을 맺고 데이터를 읽고 씀으로써 해당 소켓에서 수신 대기 중인 서비스와 통신할 수 있다. 마찬가지로 파일 시스템의 소유 권한과 접근 권한을 이용하여 소켓에 읽고 쓴느 접근을 제어할 수 있다.
- 유닉스 도메인 소켓은 운영체제의 네트워크 스택을 지나지 않기 때문에 트래픽 라우팅에 대한 오버헤드가 존재하지 않아 효울적이다. 동일한 이유로 패킷 파편화나 패킷 순서에 대해 걱정할 필요가 없다. 로컬 서비스를 사용할 때 네트워크 스택을 사용한다면, 중요한 보안상 이점과 성능 향상의 효과를 무시하게 된다.
- 주의할 점은 다른 노드간의 통신에는 사용할 수 없다.

### 유닉스 도메인 소켓 파일에 바인딩
- net.Listen, net.ListenUnix, net.ListenPacket 함수를 이요하여 사용하지 않는 유닉스 도케인 소켓 주소로 코드상에서 바인딩을 시도하면 유닉스 소켓 파일이 생성된다. 해당 소켓주소에 해당하는 소켓 파일이 존재하는 경우 운영체제는 주소가 사용 중이라는 에러를 반환한다. 대부분의 경우 존재하는 소켓 파일을 제거하는 것만으로 에러를 처리할 수 있다. 소켓 파일의 존재 유무를 반드시 확인해야만 한다.
- 소켓 파일을 재사용하려면 net 패키지늬 FileListener 함수를 이용하여 존재하는 소켓 파일에 바인딩한다. 

#### 소켓 파일의 소유권과 퍼미션 변경
- 서비스가 소켓 파일에 바인딩되고 나면 Go 언어의 os 패키지를 사용하여 파일의 소유권과 읽기/쓰기 퍼미션을 변경할 수 있다. os.Chown 함수를 이용하면 파일의 사용자 소유권 및 그룹 소유권을 변경할 수 있다.
다음 코드는 운영체제가 주어진 파일의 사용자 소유권과 그룹 소유권을 변경시키는 코드이다.
```
err := os.Chown("/path/to/socket/file",-1,100)
```
- 세 개의 매개변수는 각각 파일의 경로, 파일 소유자의 사용자 ID, 그룹 소유자의 그룹 ID 이다. 두 번째와 세번째 값이 각각 -1 인 경우 Go는 기존의 파일 권한을 그대로 유지한다. 이 예시에서는 사용자
소유권은 그대로 두고 그룹 소유권의 그룹 ID는 100으로 설정한다.
- Go의 os/user 패키지에는 사용자 ID나 그룸 ID를 이름으로, 혹은 사용자 이름이나 그룹 이름을 ID로 변환해주는 함수가 있다. 옐르 들어, 다음의 코드는 LookupGroup 함수를 이용해서 users 그룹의 그룹 ID를 찾는다.
```
grp , err := user.LookupGroup("users")
```
- os.Chmod 함수는 파일의 모드와 숫자로 표기하는 유닉스 호환 퍼미션 비트를 변경한다. 이 비트는 운영체제의 파일 모드, 파일의 사용자 읽기/쓰기/실행 퍼미션, 파일의 그룹 읽기/쓰기/실행 퍼미션,
그리고 그룹에 속하지 않은 그 외 사용자의 읽기/쓰기/실행 퍼미션의 정보를 나타낸다.
```
err := os.Chmod("/path/to/socket/file",os.ModeSocket|0660)
```

#### 유닉스 도메인 소켓 타입의 이해
- 세 종류의 유닉스 도메인 소켓이 있다. 첫 번째는 TCP처럼 동작하는 스트리밍 소켓, 두 번째는 UDP처럼 동작하는 데이터그램 소켓, 마지막으로 두 요소를 조합한 시퀀스 패킷 소켓이다. 
Go에서는 이 소켓의 종류를 각각 unix, unixgram, unixpacket으로 부릅니다. 이번 섹션에서는 각 종류별 소켓과 동작하는 에코 서버를 작성해보겠다.
- 한편 net.Conn 인터페이스로 작성된 코드는 여러 네트워크 타입에 적용할 수 있다. net.Conn 인터페이스는 TCP, UDP, 유닉스 도메인 소켓에 의해 사용되는 네트워크 소켓 간의 많은 차이점을 추상화하였다.
그래서 가령, TCP와 통신하는 코드를 작성한 후에 접속할 주소와 네트워크 타입만 변경하면 유닉스 도메인 소켓과도 통신할 수 있다.

##### 스트리밍 소켓 - unix [/streamSockUnix]
##### 데이터그램 소켓 - unixgram [/datagramSock]
- 참고로 unixgram 네트워크 타입은 Windows에서 동작하지 않는다.
##### 시퀀스 패킷 소켓 - unixpacket
- 시퀀스 패킷 소켓 타입은 세션을 지향하는 연결과 TCP의 신뢰성, 그리고 각 메시지를 구분하여 관리하는 UDP의 데이터그램의 특성을 모두 조합한 하이브리드 타입이다. 
하지만 시퀀스 패킷 소켓은 각 데이터그램이 요청하지 않은 데이터는 버려 버린다. 예를들어, 50바이트의 데이터 그램에서 32바이트만 읽으면 운영체제는 읽지 않은 18바이트는 버린다.
- unixpacket 타입은 세가지 유닉스 도메인 소켓 타입 중에서 가장 이식성이 낮다. 여러 특성이 혼용되는 하이브리드 특성과 읽지 않은 데이터는 버린다는 특성 때문에 대부분의 경우 unix, unixgram 타입의
소켓이 더 나은 선택이다. 


## 클라이언트와 인증하는 서비스 작성
- 리눅스 시스템에서 유닉스 도메인 소켓은 피어의 운영체제로부터 인증 정보를 수신하여 소켓의 반대쪽 피어의 프로세스에 대한 상세 정보를 알 수 있다. 이 정보를 이용하여 유닉스 도메인 소켓의 반대쪽에 있는 피어의 접근을 허가하거나 거부할 수 있다. 예를 들어, 회계부서_데이브라는 사용자가 유닉스 도메인 소켓을 통해 관리자 서비스에 접근하려 한다면 시스템에서는 접근을 거부해야 할 것이다.
- 특정 사용자 또는 /etc/group 파일 내의 특정한 그룹의 사용자로부터만 서비스로의 연결을 허용할 수 있다. /etc/group 파일 내의 각 그룸에는 해당하는 그룹 ID 숫자가 있다. 클라이언트가 유닉스 도메인 소켓으로 연결을 시도하면 피어의 인증 정보를 요청하고, 클라이언트의 그룹 ID가 허용된 그룹의 ID 목록에 있는지 비교해 볼 수 있다. Go의 표준 라이브러리에는 리눅스 그룹 처리를 지원하는 기능이 존재한다.

#### 피어의 인증 정보 요청
- 피어의 인증 정보를 요청하는 절차는 그렇게 직관적이지 않다. 간단히 연결 객체로부터 피어의 인증 정보를 요청할 수 없다. golang.org/x/sys/unix 패키지를 이용하여 운영체제로부터 피어의 인증 정보를 요청해야 한다. 다음의 커맨드를 사용ㅎ하여 해당 패키지를 내려받을 수 있다.
```
go get -u golang.org/x/sys/unix
```
- [/auth]의 코드는 유닉스 도메인 소켓 연결을 받아서 피어가 특정한 그룹에 속하지 않는 경우 연결을 거부하는 함수이다.

#### 서비스 작성하기[/creds]
- [/auth]에 작성한 함수를 서비스에서 사용하여 커맨드 라인에서 실행하도록 해보겠다. 이 서비스는 리눅스 운영체제의 /etc/group 파일에서 찾을 수 있는 하나 이상의 그룹 이름을 커맨드 라인의 매개변수로 받아서 유닉스 도메인 소켓 파일에서 연결 요청을 대기한다. 커맨드 라인의 매개변수로 전달한 그룹에 속한 클라이언트만이 유닉스 도메인 소켓을 이용하여 서비스에 연결할 수 있다. 서비스는 피어의 클라이언트 인증 정보를 받아온 뒤 클라이언트가 허용된 그룹에 속한 경우에는 계속 연결될 수 있도록 하며, 아닌 경우 즉시 연결을 끊는다. 서비스는 클라이언트의 그룹 ID를 이능하는 것 외의 기능은 없다.